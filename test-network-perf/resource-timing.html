<!DOCTYPE html>
<html lang=en>
<title>Examples for "Using the Resource Timing API" Guide</title>
<!--
  This example is described in MDN's "Using the Resource Timing API"
  document (https://developer.mozilla.org/en-US/docs/Web/API/Resource_Timing_API/Using_the_Resource_Timing_API).
-->
<meta name="viewport" content="width=device-width">
<script>
// log to either console of <output> element
var useConsoleLog = false;
let nIntervId;
let iCounter=0;
let timestamps=[];


function log(s) {
  if (useConsoleLog) {
    console.log(s);
  } else {
    var o = document.getElementsByTagName("output")[0];
    o.innerHTML += s + " <br>";
  }
}

function buffer_full(event) {
  log("WARNING: Resource Timing Buffer is FULL!");
}

function display_buffer_count() {
  if (performance === undefined) {
    log("= Buffer Count: peformance NOT supported");
    return;
  }
  // Log the number of resource performance items
  var list = performance.getEntriesByType("resource");
  if (list) log ("= Resource Buffer Count = " + list.length);
}

function clear_resource_timings() {
  if (performance === undefined) {
    log("= performance.clearResourceTimings(): peformance NOT supported");
    return;
  }
  // Check if Performance.clearResourceTiming() is supported
  log ("= Print performance.clearResourceTimings()");
  var supported = typeof performance.clearResourceTimings == "function";
  if (supported) {
    log("... Performance.clearResourceTimings() = supported");
    performance.clearResourceTimings();
  } else {
    log("... Performance.clearResourceTiming() = NOT supported");
    return;
  }
  // getEntries should now return zero
  var p = performance.getEntriesByType("resource");
  if (p.length == 0)
    log("... Performance data buffer cleared");
  else
    log("... Performance data buffer NOT cleared (still have `" + p.length + "` items");
}

function set_resource_timing_buffer_size(n) {
  if (performance === undefined) {
    log("= performance.setResourceTimingBufferSize(): peformance NOT supported");
    return;
  }
  // Check if Performance.setResourceTimingBufferSize() is supported
  log ("= performance.setResourceTimingBufferSize()");
  var supported = typeof performance.setResourceTimingBufferSize == "function";
  if (supported) {
    log("... Performance.setResourceTimingBufferSize() = supported");
    performance.setResourceTimingBufferSize(n);
  } else {
    log("... Performance.setResourceTimingBufferSize() = NOT supported");
  }
}

function display_size_data(){
  // Check for support of the PerformanceEntry.*size properties and print their values
  // if supported.
  if (performance === undefined) {
    log("= Display Size Data: peformance NOT supported");
    return;
  }

  var list = performance.getEntriesByType("resource");
  if (list === undefined) {
    log("= Display Size Data: peformance.getEntriesByType() is  NOT supported");
    return;
  }

  // For each "resource", display its *Size propery values
  log("= Display Size Data");
  for (var i=0; i < list.length; i++) {
    log("== Resource[" + i + "] - " + list[i].name);
    if ("decodedBodySize" in list[i])
      log("... decodedBodySize[" + i + " = " + list[i].decodedBodySize);
    else
      log("... decodedBodySize[" + i + " = NOT supported");

    if ("encodedBodySize" in list[i])
      log("... encodedBodySize[" + i + " = " + list[i].encodedBodySize);
    else
      log("... encodedBodySize[" + i + " = NOT supported");

    if ("transferSize" in list[i])
      log("... transferSize[" + i + " = " + list[i].transferSize);
    else
      log("... transferSize[" + i + " = NOT supported");
  }
}

function calculate_load_times() {
  // Check performance support
  if (performance === undefined) {
    log("= Calculate Load Times: performance NOT supported");
    return;
  }

  // Get a list of "resource" performance entries
  var resources = performance.getEntriesByType("resource");
  if (resources === undefined || resources.length <= 0) {
    log("= Calculate Load Times: there are NO 'resource' performance records");
    return;
  }

  log("= Calculate Load Times");

  

  for (var i=0; i < resources.length; i++) {

/****
connectEnd: 140.6000000089407
connectStart: 140.6000000089407
decodedBodySize: 21900
domainLookupEnd: 140.6000000089407
domainLookupStart: 140.6000000089407
duration: 131
encodedBodySize: 21900
entryType: "resource"
fetchStart: 140.6000000089407
initiatorType: "img"
name: "https://justforfun.github.io/test-network-perf/images/cat.webp?v0"
nextHopProtocol: "h2"
redirectEnd: 0
redirectStart: 0
requestStart: 144.5
responseEnd: 271.6000000089407
responseStart: 270.1000000089407
secureConnectionStart: 140.6000000089407
serverTiming: []
startTime: 140.6000000089407
transferSize: 22200
workerStart: 0

****/

    log("== Timestamp[" + i + "] - " + timestamps[i]);

    log("== Resource[" + i + "] - " + resources[i].name);
    // Redirect time
    var redirect = resources[i].redirectEnd - resources[i].redirectStart;
    log("... Redirect time = " + redirect);

    // DNS time
    var DNS = resources[i].domainLookupEnd - resources[i].domainLookupStart;
    log("... DNS lookup time = " + DNS);

    // TCP handshake time
    var TCP = resources[i].connectEnd - resources[i].connectStart;
    log("... TCP time = " + TCP);

    // Secure connection time
    var ConnectionTime = (resources[i].secureConnectionStart > 0) ? (resources[i].connectEnd - resources[i].secureConnectionStart) : "0";
    log("... Secure connection time = " + ConnectionTime);

    // Time To First Byte (TTFB)
    var TTFB = (resources[i].responseStart > 0) ? (resources[i].responseStart - resources[i].startTime) : "0";
    log("... TTFB = " + TTFB);
    

    // Response time
    var ContentDownload = resources[i].responseEnd - resources[i].responseStart;
    log("... Content Download = " + ContentDownload);

    // Fetch until response end
    var FetchUntilResponseEnd = (resources[i].fetchStart > 0) ? (resources[i].responseEnd - resources[i].fetchStart) : "0";
    log("... Fetch until response end time = " + FetchUntilResponseEnd);

    // Request start until reponse end
    var RequestStartUntilResponseEnd = (resources[i].requestStart > 0) ? (resources[i].responseEnd - resources[i].requestStart) : "0";
    log("... Request start until response end time = " + RequestStartUntilResponseEnd);

    // Start until reponse end
    var StartUntilResponseEnd = (resources[i].startTime > 0) ? (resources[i].responseEnd - resources[i].startTime) : "0";
    log("... Total time = " + StartUntilResponseEnd);
  }
}

function init() {
  // load some image to trigger "resource" fetch events
  /***
  var image1 = new Image();
  image1.src = "https://developer.mozilla.org/static/img/opengraph-logo.png";
  ***/
  var OriginalUrl="https://justforfun.github.io/test-network-perf/images/cat.webp";
  //var OriginalUrl="https://www.repstatic.it/content/nazionale/img/2022/04/03/130714361-c3b4a7f4-6f4f-41d6-8431-ba8ad8d51710.jpg";

  
  timestamps[iCounter]=CreateReadableTimestamp();
  
  var UrlToFetch = OriginalUrl+"?v"+iCounter;
  var image2 = new Image();
  image2.src = UrlToFetch;
  iCounter++;

  log("Init function executed "+ iCounter + " times");

  // Set a callback if the resource buffer becomes filled
  performance.onresourcetimingbufferfull = buffer_full;

}

function CreateReadableTimestamp() {
  var Seconds="";
  var Minutes="";
  var Hours="";

  const datetostore = new Date();
  
  if(datetostore.getSeconds()<10)
    Seconds="0"+datetostore.getSeconds();
  else
    Seconds=datetostore.getSeconds();

  if(datetostore.getMinutes()<10)
    Minutes="0"+datetostore.getMinutes();
  else
    Minutes=datetostore.getMinutes();

  if(datetostore.getHours()<10)
    Hours="0"+datetostore.getHours();
  else
    Hours=datetostore.getHours();

  var ReadableTimestamp=
  datetostore.getDate()+
          "/"+(datetostore.getMonth()+1)+
          "/"+datetostore.getFullYear()+
          " "+Hours+
          ":"+Minutes+
          ":"+Seconds+
          " TZ Offset: "+datetostore.getTimezoneOffset();
  
  return(ReadableTimestamp);        
}

function startTesting() {

  if (!nIntervId) {
    nIntervId = setInterval(init, 5000);
  }
}

function stopTesting() {
  clearInterval(nIntervId);
  // release our intervalID from the variable
  nIntervId = null; 
  iCounter=0;
}

</script>
<body onload="init()">
<h1>Resource Timing examples</h1>
<button id="log" onclick="startTesting();">Start Testing</button>
<p></p>
<button id="log" onclick="stopTesting();">Stop Testing</button>
<p></p>
<button id="log" onclick="calculate_load_times();">Calculate resource load times</button>
<p></p>
<button id="log" onclick="display_size_data();">Display resource size data</button>
<p></p>
<button id="log" onclick="display_buffer_count();">Display resource buffer count</button>
<p></p>
<button id="log" onclick="clear_resource_timings();">Clear resource timings</button>
<p></p>
<button id="log" onclick="set_resource_timing_buffer_size(160);">Set resource timing buffer size</button>
<p></p>
<div id="populateresult">
  <table id="emptbl">
    <tr>
      <th>Time</th>
      <th>DNS</th>
      <th>TCP</th> 
    </tr> 
      
  </table>
  <div id="col0"></div>
  <div id="col1"></div>
  <div id="col2"></div>
</div>
<output></output>
</body>
</html>
